name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        preset:
          - "Waveshare_rp2040_pizero"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build cmake build-essential \
            gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Verify pico-sdk path
        run: |
          test -f third_party/pico-sdk/pico_sdk_init.cmake
          echo "pico-sdk OK: $(git -C third_party/pico-sdk rev-parse --short HEAD 2>/dev/null || true)"

      - name: Generate CMakePresets.json
        run: |
          python3 scripts/generate_presets.py --generator Ninja
          cmake --list-presets
          cmake --list-presets=build

      - name: Configure
        run: cmake --preset "${{ matrix.preset }}"

      - name: Build
        run: cmake --build --preset "${{ matrix.preset }}"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.preset }}
          if-no-files-found: error
          path: |
            build/**/**/*.uf2
            build/**/**/*.elf
            build/**/**/*.bin
            build/**/**/*.hex
            build/**/**/*.map
